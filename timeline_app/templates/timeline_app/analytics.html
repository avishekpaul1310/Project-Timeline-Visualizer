{% extends 'timeline_app/base.html' %}
{% block title %}Analytics - Timeline Visualizer{% endblock %}

{% block content %}
<!-- Invisible data elements to transfer Django data to JavaScript -->
<div id="django-data" style="display: none;"
    data-completion-percentage="{{ milestone_stats.completion_percentage|default:0 }}"
    data-completed-count="{{ milestone_stats.completed|default:0 }}"
    data-total-count="{{ milestone_stats.total|default:0 }}"
    data-in-progress-count="{{ milestone_stats.in_progress|default:0 }}"
    data-pending-count="{{ milestone_stats.pending|default:0 }}"
    data-delayed-count="{{ milestone_stats.delayed|default:0 }}"
    data-overdue-count="{{ milestone_stats.overdue|default:0 }}"
    data-month-labels="{{ month_labels|safe }}"
    data-month-counts="{{ month_counts|safe }}">
</div>

<div class="row mb-4">
    <div class="col">
        <h1>Project Analytics</h1>
    </div>
</div>

<!-- Project Stats Cards Row -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Total Projects</h5>
                <h2 class="display-4">{{ total_projects }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Active Projects</h5>
                <h2 class="display-4">{{ active_projects }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Archived Projects</h5>
                <h2 class="display-4">{{ archived_projects }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Milestone Completion Stats Row -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">Milestone Completion Rate</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h2 id="completion-percentage" class="display-4">0%</h2>
                    <p id="completion-count" class="text-muted">Milestones Completed: 0 out of 0</p>
                </div>
                
                <!-- Progress bar with ID for JavaScript targeting -->
                <div class="progress mb-3" style="height: 25px;">
                    <div id="completion-progress" 
                         class="progress-bar bg-success" 
                         role="progressbar"
                         style="width: 0%;"
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        0%
                    </div>
                </div>
                
                <div class="row text-center">
                    <div class="col">
                        <div class="p-2 bg-light rounded">
                            <h5 id="completed-count">0</h5>
                            <small class="text-muted">Completed</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="p-2 bg-light rounded">
                            <h5 id="in-progress-count">0</h5>
                            <small class="text-muted">In Progress</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="p-2 bg-light rounded">
                            <h5 id="pending-count">0</h5>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                    <div class="col">
                        <div id="overdue-container" class="p-2 bg-light rounded">
                            <h5 id="overdue-count">0</h5>
                            <small id="overdue-label" class="text-muted">Overdue</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">Top Projects by Milestones</h5>
            </div>
            <div class="card-body">
                {% if top_projects %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Milestones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in top_projects %}
                        <tr>
                            <td>
                                <a href="{% url 'timeline_app:project_detail' project.id %}">
                                    {{ project.name }}
                                </a>
                            </td>
                            <td>{{ project.milestone_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-info">
                    No projects with milestones found.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Original Charts Row -->
<div class="row mb-4">
    <!-- Project Creation Over Time Chart -->
    <div class="col-md-8 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">Projects Created Over Time</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="projectsChart"></canvas>
                </div>
                <div id="projects-chart-empty" class="alert alert-info text-center mt-3 d-none">
                    <p>No project creation data available yet.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Milestone Stats -->
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">Milestone Status</h5>
            </div>
            <div class="card-body">
                <div style="height: 260px;">
                    <canvas id="milestoneChart"></canvas>
                </div>
                <div id="milestone-chart-empty" class="alert alert-info text-center mt-3 d-none">
                    <p>No milestone data available yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log("Analytics JavaScript running");
        
        // Get data from Django template
        const djangoData = document.getElementById('django-data');
        console.log("Django data element found:", djangoData);
        
        if (!djangoData) {
            console.error("Could not find django-data element");
            return;
        }
        
        // Log the raw dataset
        console.log("Raw dataset:", djangoData.dataset);
        
        // Milestone stats - using getAttribute directly instead of dataset
        const completionPercentage = parseInt(djangoData.getAttribute('data-completion-percentage') || 0);
        const completedCount = parseInt(djangoData.getAttribute('data-completed-count') || 0);
        const totalCount = parseInt(djangoData.getAttribute('data-total-count') || 0);
        const inProgressCount = parseInt(djangoData.getAttribute('data-in-progress-count') || 0);
        const pendingCount = parseInt(djangoData.getAttribute('data-pending-count') || 0);
        const delayedCount = parseInt(djangoData.getAttribute('data-delayed-count') || 0);
        const overdueCount = parseInt(djangoData.getAttribute('data-overdue-count') || 0);
        
        console.log("Parsed stats:", {
            completionPercentage, completedCount, totalCount,
            inProgressCount, pendingCount, delayedCount, overdueCount
        });
        
        // Update milestone statistics in the DOM
        document.getElementById('completion-percentage').textContent = completionPercentage + '%';
        document.getElementById('completion-count').textContent = 
            `Milestones Completed: ${completedCount} out of ${totalCount}`;
        
        // Update progress bar
        const progressBar = document.getElementById('completion-progress');
        progressBar.style.width = completionPercentage + '%';
        progressBar.setAttribute('aria-valuenow', completionPercentage);
        progressBar.textContent = completionPercentage + '%';
        
        // Update count displays
        document.getElementById('completed-count').textContent = completedCount;
        document.getElementById('in-progress-count').textContent = inProgressCount;
        document.getElementById('pending-count').textContent = pendingCount;
        document.getElementById('overdue-count').textContent = overdueCount;
        
        // Update overdue styling if needed
        if (overdueCount > 0) {
            const overdueContainer = document.getElementById('overdue-container');
            overdueContainer.classList.remove('bg-light');
            overdueContainer.classList.add('bg-danger', 'text-white');
            
            const overdueLabel = document.getElementById('overdue-label');
            overdueLabel.classList.remove('text-muted');
            overdueLabel.classList.add('text-white');
        }
        
        // Parse chart data
        let monthLabels;
        let monthCounts;
        
        try {
            const monthLabelsAttr = djangoData.getAttribute('data-month-labels');
            const monthCountsAttr = djangoData.getAttribute('data-month-counts');
            
            console.log("Month labels attribute:", monthLabelsAttr);
            console.log("Month counts attribute:", monthCountsAttr);
            
            monthLabels = JSON.parse(monthLabelsAttr || '[]');
            monthCounts = JSON.parse(monthCountsAttr || '[]');
            
            console.log("Parsed month labels:", monthLabels);
            console.log("Parsed month counts:", monthCounts);
        } catch (error) {
            console.error('Error parsing chart data:', error);
            monthLabels = [];
            monthCounts = [];
        }
        
        // Create Projects Chart
        // In the part that handles the projects chart
const projectsChartEmpty = document.getElementById('projects-chart-empty');
console.log("Month labels length:", monthLabels.length);
console.log("Month counts length:", monthCounts.length);

if (monthLabels && monthLabels.length > 0 && monthCounts && monthCounts.length > 0) {
    console.log("Creating projects chart with data:", { monthLabels, monthCounts });
    try {
        const projectsChartElement = document.getElementById('projectsChart');
        if (!projectsChartElement) {
            console.error("Projects chart canvas element not found");
        } else {
            console.log("Canvas element found, creating chart...");
            const projectCtx = projectsChartElement.getContext('2d');
            new Chart(projectCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Projects Created',
                        data: monthCounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            console.log("Projects chart created successfully");
        }
    } catch (error) {
        console.error("Error creating projects chart:", error);
        projectsChartEmpty.classList.remove('d-none');
    }
} else {
    console.log("No project data available, showing empty message");
    projectsChartEmpty.classList.remove('d-none');
}
    } catch (error) {
        console.error("Error in analytics script:", error);
    }
});
</script>
{% endblock %}