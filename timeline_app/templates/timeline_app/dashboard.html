<!-- timeline_app/templates/timeline_app/dashboard.html -->
{% extends 'timeline_app/base.html' %}

{% block content %}
<!-- Add CSS for chart container -->
<style>
    .chart-container {
        height: 400px;
        position: relative;
        margin-bottom: 2rem;
    }
    .project-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .project-card {
        transition: all 0.3s ease;
    }
    .project-card:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>My Projects</h2>
    <div>
        <a href="{% url 'timeline_app:archived_projects' %}" class="btn btn-secondary me-2">
            <i class="fas fa-archive"></i> Archived Projects
        </a>
        <a href="{% url 'timeline_app:project_create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New Project
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">Project Timeline</h4>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="timeline-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">Project List</h4>
            </div>
            <div class="card-body">
                <div class="list-group project-list">
                    {% for project in projects %}
                    <a href="{% url 'timeline_app:project_detail' project.id %}"
                        class="list-group-item list-group-item-action project-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-1">{{ project.name }}</h5>
                        </div>
                        <small class="text-muted d-block">
                            Start: {{ project.start_date|date:"M d, Y" }}
                        </small>
                        <small class="text-muted d-block">
                            End: {{ project.end_date|date:"M d, Y" }}
                        </small>
                    </a>
                    {% empty %}
                    <div class="text-center p-4">
                        <p class="text-muted mb-0">No projects yet.</p>
                        <small>Create your first project to get started!</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            const projectsRaw = '{{ projects_json|escapejs }}';
            console.log("Raw JSON string:", projectsRaw);
            
            const projects = JSON.parse(projectsRaw);
            console.log("Parsed projects data:", projects);
            
            // Check if projects exist
            if (!projects || !projects.length) {
                console.log("No projects found");
                return;
            }

            // Manually construct data points
            const dataPoints = projects.map(p => {
                console.log(`Processing project: ${p.name}`);
                const startDate = new Date(p.start_date);
                const endDate = new Date(p.end_date); 
                console.log(`Start date: ${startDate}, End date: ${endDate}`);
                
                return {
                    x: [startDate, endDate],
                    y: p.name
                };
            });
            
            console.log("Data points:", dataPoints);
            
            const projectData = {
                datasets: [{
                    label: 'Projects Timeline',
                    data: dataPoints,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.8
                }]
            };

            window.timelineChart = new Chart(ctx, {
                type: 'bar',
                data: projectData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            position: 'top',
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d, yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Timeline',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error initializing chart:', error);
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="alert alert-warning text-center">
                        <p>Unable to load the timeline chart. Error: ${error.message}</p>
                        <small>Please check console for details.</small>
                    </div>
                `;
            }
        }
    });
</script>
{% endblock %}